网页屏幕键盘的原理及安全性分析

一、网页屏幕键盘的原理

通过编程进行软件实现。

例如：基于QT/E软键盘的实现（《基于QT/E的嵌入式Linux系统的软键盘实现》作者：谢芳，潘丽，刘守印 《电子设计工程》2012.05）
设计需要软键盘有数字键、字母键、退出键和确定键，需要共42个按键。因此，软键盘外框搭建大小为540*160，并在外框内加入所需按键。如图
![](http://i.imgur.com/8YDEoAc.png)
实现步骤：

1、在输入前先初始化按键

2、建立每个按键与对应值的映射

3、建立每个按键对应的键值的clicked（QT/E中的信号函数）和信号槽的一一对应关系

4、将键值传递给焦点控件（发送给外部输出），发送函数会将这次点击的键值发送给外部输出，并且清除焦点控件中储存的值，供下一次输入使用。

二、网页屏幕键盘的安全性

1、使用物理键盘输入时的不安全因素：

按键记录木马：这个木马用于记录物理键盘击键。由三个模块组成：主模块，负责在系统中安装一个全局“钩子”；“钩子”模块，负责将每次按键事件汇报给主模块，主模块得到“钩子”模块的汇报后，将所有的击键记录保存在一个文件中；FPT模块，当这个储存文件大小达到一定的时候，主模块启动FPT模块，把这个文件上传到一个FPT服务器，或者通过自身的邮件发送模块，发送到黑客的邮箱里。（引《软键盘技术研究和改进》顾海艳等《电脑知识与技术》2008.12）

2、应对方法：使用网页屏幕键盘

屏幕键盘又称软键盘或者虚拟键盘，是一种通过软件模拟物理键盘输入的技术，使用鼠标点击屏幕上的按键输入信息，因为输入的是鼠标信息，所以物理层和内核层的攻击即使拦截到鼠标信息，也无法解析语义。（引《基于细胞自动机的软键盘布局随机化方案》李鹏伟等《北京交通大学学报》2013.10）

3、屏幕键盘的不安全因素：（引《基于细胞自动机的软键盘布局随机化方案》李鹏伟等《北京交通大学学报》2013.10）

（1）、消息截获：物理键盘可以使用应用层的键盘记录程序截获按键信息，浏览器中使用的软键盘，可以使用IE的COM借口编程来截获软键盘的输入。可以通过加密活加入干扰信息等方式进行保护。

（2）、偷窥：利用低质量图像，根据软键盘的布局和用户点击的大致位置来判断，从而会付出用户的输入字符。可以通过改变软键盘的布局，让软键盘进行动态变换，来提高偷窥难度。

（3）、截屏：使用恶意代码，在用户每次点击软键盘的时候进行截屏，利用截屏的图像，得到用户的输入信息。

（4）、鼠标记录：利用软键盘的外观，位置，进行输入的时间等信息，再对用户用软键盘进行输入时的鼠标单击位置进行记录，就可以根据鼠标的单击位置判断出点击的按键。

4、对建设银行的网银登陆系统的安全分析：
   
登陆界面，如图： 
![](http://i.imgur.com/HGh6nTv.png)
在这个页面的源代码中，找到登陆密码对应的那部分：
![](http://i.imgur.com/KH63WPo.png)
其中这一段是键盘输入，
![](http://i.imgur.com/57UnhoS.png)
获取表单密码框中输入的密码，并用定义好的keyJiami函数进行加密的过程。

下面的软键盘开始，就是使用软键盘输入密码的过程，这里显示的主要是对IE6和IE7的特殊处理，软键盘生成的代码在开发人员工具里，如下：
![](http://i.imgur.com/sUFj2OK.png)
点击红框中的图片，对应的网页中软键盘的按键，程序就运行到如下图这里开启软键盘
![](http://i.imgur.com/78tbWyL.png)
这是动态生成软键盘的实现。用户在用鼠标点击软键盘时，运行onclick="if (true) { $('LOGPASS').value = ''; password1 = $('LOGPASS'); showkeyboard(); $('LOGPASS').readOnly = 1; $('Calc').password.value = ''; };这个函数记录密码字符串，在用户点击登录之后，进行一系列判断（并不包括密码是否输入正确，只判定用户名和密码的规范性）：
![](http://i.imgur.com/bLl1M1P.png)
并使用这个jiamiMimas的函数，讲刚才得到的LOGPASS密码值进行加密。关于判断密码正确与否的算法，没有在源代码中找到，我猜想应该为了保密性放在后台处理了。
这就是软键盘输入和用户登录的大概过程。

三、个人分析：

在看代码的时候，看到了几处基本的安全策略，比如在进入建行登录页面时有判定是否安全登录的函数，有获取网站安全证书的函数，建行安全控件的下载安装，以及对输入密码的加密处理传输和对软键盘的优化，使软键盘动态生成。

对比直接使用物理键盘方式输入密码，屏幕键盘是否改进了安全性？请详细阐述理由。

我觉得屏幕键盘的安全性好一点。至于理由，我也只想到一点：
物理键盘最大的不安全性，就在于会记录，这个记录不仅仅是来源于木马这种记录击键的恶意软件，也可以来源于人。有很多记录密码的手法，我曾经看到就有在取款机上去指纹，还有利用取款机上残留的手上的油脂，找轻的东西被油脂粘上就能看出摁哪六个键，甚至是用生日，手机，这种社会工程学的方法。我就看过一个同学输入手机解锁密码，明显是ABAB型的密码，加上我也知道一些和这个同学有关的数字，猜了几次就猜出来了。所以这种在键盘上输入密码养成的固定习惯，是很容易被发现的事情，就是因为习惯了，知道按完a就按b，加上一些了解和推断，很容易暴露密码。这可以说是利用了手指对键盘的记忆能力。相反，把键盘放到屏幕上，使用鼠标点击的时候，首先，屏幕键盘大多是动态生成的，数字不按熟悉的田字格排列，要找下一个，就需要花掉时间，其次就是字母，根本不可能像在物理键盘上那样流畅的输入。这就使记录击键变得很困难，当然，如果是那种截屏攻击，就另当别论。

相对于物理键盘来说，机械键盘改进的最明显的安全策略就是用鼠标点击和键盘的动态化。这可以让不熟悉的人，无法从输入的规律着手破解密码。但是例如在登录个人网银的时候，最关键的安全策略还是在于后台系统对输入的密码字符串进行随机密码的加密。这种安全机制，是种类似于尽人事听天命的方法。只要银行后台加密算法中的随机密钥没有泄露，我输入的密码就是保密的；只要我建行U盾没有弄丢，我的私钥就是保密的，我用这个私钥对银行发起交易请求，这种交易就是完全安全可信的。显然不一定成立。上面提到的截屏和鼠标记录木马，都会得到鼠标点击的信息从而缩小分析范围，甚至是直接得到输入的密码。此外，对于微软的IE浏览器，没有页面嵌套的网页，IE的IHTMLInputTextElement借口存在安全漏洞，在表单密码输入框的内容可能会通过这个借口读取出来（引《基于动态软键盘的口令认证安全用户端的研究和实现》么贻聪）。而且建行的判定密码正确与否的函数在后台，没有谁完全可以保证在传送密码这个参数的时候不会被攻击者截获，甚至在第一次登陆网银进行注册的时候，设定登陆密码时，就有可能被进行中间人攻击。

所以，我觉得屏幕键盘输入在物理键盘的基础上更加安全，但在登陆网银或者网上交易输入密码的时候，屏幕键盘只是众多安全机制中的一环，而其中任意一环没有做好，就可能存在安全隐患。但单独从输入过程的安全性上来说，屏幕键盘肯定比物理键盘更加安全。毕竟少了一个物理层面上的环节，只有虚拟的光标和虚拟的键盘进行交互，安全性更高。