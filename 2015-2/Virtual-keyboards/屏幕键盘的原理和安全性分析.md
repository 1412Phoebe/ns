# 逆向分析/点评 #
----------
10/22/2015 12:39:52 PM
### 屏幕键盘的原理和安全性分析 ###

分析对象至少应包含以下2家：

- 中传的一卡通在线充值转账系统
- 建设银行个人网银登录

对比直接使用物理键盘方式输入密码，屏幕键盘是否改进了安全性？请详细阐述理由。

### 安全背景 ###

翻译自wiki百科：

虚拟键盘（Virtual keyboards）可以用于降低键盘监听（keystroke logging）的风险。例如，西太平洋的网上银行服务使用虚拟键盘输入密码，如treasurydirect。

![treasurydirect](http://upload.wikimedia.org/wikipedia/en/thumb/f/fa/TreasuryDirectLoginScreen.PNG/695px-TreasuryDirectLoginScreen.PNG)

对于恶意软件（malware）来说，他们想要通过监测显示和鼠标来获取虚拟键盘的输入比监测真正的键盘困难很多。但是这种监控也是可以实现的，比如在有规律的时间间隔内记录屏幕截图或每一次鼠标的点击。

使用鼠标点击网络屏幕键盘，可能会增加用户密码泄露的风险，如肩窥（shoulder surfing）。
> 肩窥（shoulder surfing）指使用直接的观察技术，如通过某人的肩膀来查看，来获取信息。在款台刷卡结账时，排在后面的顾客多半会后退一步，主动回避。可有些人偏偏就要凑上来看你输密码，实在让人无法忍受。这种行为英语里叫做shoulder surfing.

一个窥视者通常看屏幕比看键盘更容易，可以看到鼠标移向了哪些字符。一些屏幕键盘也许会给出一些视觉反馈，比如点击的时候颜色会出现变化。最坏的情况下，最近点击的一个键会持续给出反馈，直到点击下一个键被点击。一个用户可能不能够“确定和点击”的和在实际键盘上一样快，所以这也为窥视者提供了便利条件。

###对象背景###
**一、中传的一卡通在线充值转账系统**

1、一卡通在线充值转账系统情况概述：

校园卡电子服务平台 [http://ykt.cuc.edu.cn/](http://ykt.cuc.edu.cn/)
用校外网无法登录此电子服务平台。校园卡电子服务平台未加密，为http协议，登录时使用CAS认证。
> CAS = Central Authentication Service，中央认证服务，一种独立开始指令协议。CAS 是 Yale 大学发起的一个开源项目，旨在为 Web 应用系统提供一种可靠的单点登录方法，CAS 在 2004 年 12 月正式成为 JA-SIG 的一个项目。
> ![CAS认证](http://b.hiphotos.baidu.com/baike/c0%3Dbaike180%2C5%2C5%2C180%2C60/sign=fff8c229b9014a9095334eefc81e5277/f3d3572c11dfa9ec6bfc2b8c62d0f703908fc15f.jpg)
> 从结构上看，CAS 包含两个部分： CAS Server 和 CAS Client。CAS Server 需要独立部署，主要负责对用户的认证工作；CAS Client 负责处理对客户端受保护资源的访问请求，需要登录时，重定向到 CAS Server。

2、校园卡电子服务平台登录界面：

![校园卡电子服务平台登录界面](http://7xo6vj.com1.z0.glb.clouddn.com/15-11-12/15318691.jpg)

3、软键盘安全性：

连续刷新十次，得到不同的软键盘：

1. 9721685430
2. 7613095824
3. 2831406975
4. 2367904158
5. 1836450297
6. 5179482630
7. 9816235704
8. 1873526490
9. 9524378610
10. 9182034675

可以看到，每次软键盘数字的排列都是随机打乱的。

    由chorme开发者工具得到的代码：

    <p id="p_cxmm" class="cardTransferInfo">
        <label>
            查询密码：</label>
        <input type="password" id="Password" name="password" readonly="readonly" maxlength="6" class="validate[required,minSize[6],maxSize[6]]" style="background-color:#f99; border:#f00 1px solid;"><span class="red">*(校园卡查询密码)</span></p>
    <div class="virtualKey" id="password_key_transfer" style="">
        <img src="/Account/GetNumKeyPadImg" alt="密码键盘" usemap="#keyboardMapForPwd" width="300" height="61">
        <map name="keyboardMapForPwd" id="keyboardMapForPwd">
            <area shape="rect" coords="4,3,29,28" value="0">
            <area shape="rect" coords="33,3,58,28" value="1">
            <area shape="rect" coords="62,3,88,28" value="2">
            <area shape="rect" coords="92,3,118,28" value="3">
            <area shape="rect" coords="122,3,148,28" value="4">
            <area shape="rect" coords="152,3,178,28" value="5">
            <area shape="rect" coords="182,3,207,28" value="6">
            <area shape="rect" coords="211,3,236,28" value="7">
            <area shape="rect" coords="241,3,266,28" value="8">
            <area shape="rect" coords="270,3,295,28" value="9">
            <area shape="rect" coords="5,33,74,148" value="Backspace">
            <area shape="rect" coords="78,33,221,148" value="Clear">
            <area shape="rect" coords="227,33,295,148" value="Close">
        </map>
    </div>
    

从这段代码中，可以发现：

- 密码键盘不是真正可点击键盘，而是一个图像，其地址为：/Account/GetNumKeyPadImg。浏览器中输入此地址，是不可以看到相应图像键盘的。
- 代替键盘输入的方式，是用shape、coords等HTML元素规定区域的尺寸、形状和位置，点击坐标区域给出相应value。

4、使用Chorme中Network工具

可探查到：

![data](http://image17-c.poco.cn/mypoco/myphoto/20151126/11/17868435620151126113627029_640.jpg?330x109_130)

此passord与输入的并不一致。

可探测到Cookie：

![cookie](http://image17-c.poco.cn/mypoco/myphoto/20151126/11/17868435620151126113456058_640.jpg?894x385_130)

5、测试：
General:
Remote Address:202.205.25.18:80
Request URL:http://ykt.cuc.edu.cn/CardManage/CardInfo/TransferAccount
Request Method:POST
Status Code:200 OK

>200请求成功 303重定向 400请求错误 401未授权 
>403禁止访问 404文件未找到 500服务器错误

Response Headers:
Cache-Control:private
Content-Length:55
Content-Type:application/json; charset=utf-8
Date:Thu, 26 Nov 2015 03:57:47 GMT
Server:Microsoft-IIS/7.5
X-AspNet-Version:4.0.30319
X-AspNetMvc-Version:3.0
X-Powered-By:ASP.NET

**view source:**
HTTP/1.1 200 OK
Cache-Control: private
Content-Type: application/json; charset=utf-8
Server: Microsoft-IIS/7.5
X-AspNetMvc-Version: 3.0
X-AspNet-Version: 4.0.30319
X-Powered-By: ASP.NET
Date: Thu, 26 Nov 2015 03:57:47 GMT
Content-Length: 55

Request Headers:
Accept:*/*
Accept-Encoding:gzip, deflate
Accept-Language:zh-CN,zh;q=0.8
Connection:keep-alive
Content-Length:81
Content-Type:application/x-www-form-urlencoded
Cookie:ASP.NET_SessionId=1fj4eivlu2cgee3onxpy5c1g; iPlanetDirectoryPro=U3luU25vXzIwMTMxMTEyMzAyN18yMDE1MTEyNjExNTY1MDQ4MTA%3d
Host:ykt.cuc.edu.cn
Origin:http://ykt.cuc.edu.cn
Referer:http://ykt.cuc.edu.cn/
User-Agent:Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36
X-Requested-With:XMLHttpRequest

**view source:**
POST /CardManage/CardInfo/TransferAccount HTTP/1.1
Host: ykt.cuc.edu.cn
Connection: keep-alive
Content-Length: 81
Accept: */*
Origin: http://ykt.cuc.edu.cn
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Referer: http://ykt.cuc.edu.cn/
Accept-Encoding: gzip, deflate

> DEFLATE是同时使用了LZ77算法与哈夫曼编码（Huffman Coding）的一个无损数据压缩算法。
> GZIP最早由Jean-loup Gailly和Mark Adler创建，用于UNⅨ系统的文件压缩。我们在Linux中经常会用到后缀为.gz的文件，它们就是GZIP格式的。现今已经成为Internet 上使用非常普遍的一种数据压缩格式，或者说一种文件格式。


Accept-Language: zh-CN,zh;q=0.8
Cookie: ASP.NET_SessionId=1fj4eivlu2cgee3onxpy5c1g; iPlanetDirectoryPro=U3luU25vXzIwMTMxMTEyMzAyN18yMDE1MTEyNjExNTY1MDQ4MTA%3d

Form Data:
password:499409
checkCode:7383
amt:10.00
fcard:bcard
tocard:card
bankno:
bankpwd:

**view source:**
password=499409&checkCode=7383&amt=10.00&fcard=bcard&tocard=card&bankno=&bankpwd=

## 重大发现！ ##
在查询密码处使用电子键盘进行输入，不论键盘的随机性如何改变：
以下列软键盘为例：

![软键盘例子](http://image17-c.poco.cn/mypoco/myphoto/20151130/17/1786843562015113017284804_640.jpg?230x44_130)

若输入6个第一个键盘上的数7，则network中password的值为6个0.
若输入6个第二个键盘上的数1，则network中password的值为6个1，以此类推。
7120465389
若输入777111，则network中password的值为111000.
若输入111222，则network中password的值为222111，以此类推。


若输入771122，则network中password的值为221100.
若输入998833，则network中password的值为778899，以此类推。

又经过了数次实验后，基本可以推出：键盘给后端或服务器的上传值并不是软键盘本身的数值。而是相当于7120465389对应着顺序序列0123456789，输入7则反馈为0.
但是这种反馈并不是简单的置换，经过数次实验后，可以得出：上传值是对应着顺序序列0123456789并加上一些简单的反转得出。如若输入771122，network中的反馈值并不是0011122，而是经过反转后的221100.

再次实验，此时输入的值不是简单的具有排列规则的数字串了。


> 以“024004”为例，network中的反馈值为“433423”.
> 
> 软键盘：   7  1  2  0  4  6  5  3  8  9
> 
> 顺序序列： 0  1  2  3  4  5  6  7  8  9
> 
> 输入： 024004
> 分析：
> 软键盘上，数字“0”对应顺序序列“3”，数字“2”对应顺序序列“2”，数字“4”对应顺序序列“4”。
> 经过顺序序列翻译过的输入应该为“324334”.
> 
> 而network中的反馈值为“433423”.正好为顺序序列翻译过的输入“324334”的反转值。匹配成功！


> 以“201530”为例，network中的反馈值为“376132”.
> 
> 软键盘：   7  1  2  0  4  6  5  3  8  9
> 
> 顺序序列： 0  1  2  3  4  5  6  7  8  9
> 
> 输入： 201530
> 分析：
> 软键盘上，数字“2”对应顺序序列“2”，数字“0”对应顺序序列“3”，数字“1”对应顺序序列“1”，数字“5”对应顺序序列“6”，数字“3”对应顺序序列“7”。
> 经过顺序序列翻译过的输入应该为“231673”.
> 
> 而network中的反馈值为“376132”.正好为顺序序列翻译过的输入“231673”的反转值。匹配成功！


经过以上两个实验的相应分析后，我们可知道：

如果采用这样的网络屏幕键盘，如果攻击者抓到了network交互中的POST包，可获取其中的password值，进而可经过一系列分析得出使用者的密码。
我之所以能够分析成功，也是因为网页每次进行提交的时候并没有刷新键盘。这样在我输入错误的时候，下次我还是可以使用同样的一个键盘进行分析。

安全建议：

1. 每次做出POST请求时刷新页面，更换屏幕键盘。
2. 但最重要的一点还是更换交给后端判断时的密码加密算法。


**二、建设银行个人网银登录**

1、建设银行个人网银登录情况概述：

中国建设银行个人网上银行可用任何网络登录。使用https全站加密。
 [https://ibsbjstar.ccb.com.cn/app/V5/CN/STY1/login.jsp?UDC_CUSTOMER_ID=&UDC_CUSTOMER_NAME=&UDC_COOKIE=55db7a7686c3567fovXFSTsXQwrDHKJbu3Gi1447316596250oAeRkYNfiXp211LrdCCg6adec1ee677022fc1c1a341abebc2f14&UDC_SESSION_ID=ZT1EMzx79kGMLjQac5484c63d48-20151112162319](https://ibsbjstar.ccb.com.cn/app/V5/CN/STY1/login.jsp?UDC_CUSTOMER_ID=&UDC_CUSTOMER_NAME=&UDC_COOKIE=55db7a7686c3567fovXFSTsXQwrDHKJbu3Gi1447316596250oAeRkYNfiXp211LrdCCg6adec1ee677022fc1c1a341abebc2f14&UDC_SESSION_ID=ZT1EMzx79kGMLjQac5484c63d48-20151112162319)

2、中国建设银行个人网上银行登录界面：

![建设银行个人网银登录界面](http://7xo6vj.com1.z0.glb.clouddn.com/15-11-12/83407004.jpg)

3、软键盘安全性：

打开软键盘后的界面：

![建设银行个人网银软键盘](http://7xo6vj.com1.z0.glb.clouddn.com/15-11-12/87155860.jpg)

连续刷新十次，得到不同的软键盘：

1. 1074569823
2. 3694157802
3. 7248156093
4. 1936508274
5. 1834207695
6. 8624537109
7. 7134502698
8. 4520937816
9. 4230587196
10. 1052476893

11/12/2015 10:08:30 PM 

可以看到，每次软键盘数字的排列都是随机打乱的。

    由chorme开发者工具得到的代码：

    <tr>
	<td class="tar">登录密码：</td>
	<td>

	 <input style="vertical-align:middle;width:154px;" name="LOGPASS" id="LOGPASS" type="password" autocomplete="off" size="20" minlength="6" maxlength="12" title="登录密码" onchange="$('Calc').password.value=this.value;
	 keyJiami(this);" onfocus="if($('softkeyboard').style.display == 'none'){ if(isShowKeyboard()){this.value = ''; 
	 password1=this; showkeyboard(); this.readOnly=1; $('Calc').password.value='';} if(useSoftBoard){this.value = '';
	 useSoftBoard = false;}}" readonly=""> 
	
     <!--软键盘 开始-->
                     
     <div id="span0" class="rujian1" title="软键盘指软件模拟键盘，您可以通过鼠标点击输入字符，防止木马记录键盘输入的密码。" onclick="if (true) { $('LOGPASS').value = ''; password1 = $('LOGPASS'); showkeyboard(); $('LOGPASS').readOnly = 1; $('Calc').password.value = ''; };">
     <img src="/V5/images5/softkeyboard.gif" width="56" height="18" border="0" alt="" id="img_id">
     </div>
                            
     <script>

       try {	 
            var isCurrIE6=(navigator.userAgent.toLowerCase().indexOf("msie 6.0") != -1);
            var isCurrIE7=(navigator.userAgent.toLowerCase().indexOf("msie 7.0") != -1);
            //IE6特殊处理
            if(isCurrIE6)	{
                                document.getElementById("span0").className = "ruanjian"; 
                                var obj=document.getElementById("icon_event");
                            	obj.attachEvent("onmouseover",function(){ document.getElementById("icon_pop").style.display = "block"; document.getElementById("img_id").style.display = "none";});
                            	obj.attachEvent("onmouseout",function(){ document.getElementById("icon_pop").style.display = "none";  document.getElementById("img_id").style.display = ""; });
                              }
                              if(isCurrIE7){
                            	document.getElementById("span0").style.left = "217px"; 
                            	document.getElementById("span0").style.top = "131px"; 
                            	var obj=document.getElementById("icon_event");
                            	obj.attachEvent("onmouseover",function(){ document.getElementById("img_id").style.display = "none";});
                            	obj.attachEvent("onmouseout",function(){  document.getElementById("img_id").style.display = ""; });
                              }
          } catch (e) {}
       </script>   

       <!--软键盘 结束-->	 
       </td>
	   <td width="30px"></td>
	   <td class="form_area_table_r" style="padding-left:0px;"><a tabindex="-1" href="#" onclick="refreshLoginPwd();">忘记密码？</a></td>
	   </tr>

       <div align="center" id="softkeyboard" name="softkeyboard" style="position: absolute; left: 14px; top: 141px; width: 400px; z-index: 65535; display: block;"><table id="CalcTable" width="" border="0" align="center" cellpadding="0" cellspacing="0" bgcolor="" style="border: 1px solid rgb(181, 173, 241);"><form id="Calc" name="Calc" action="" method="post" autocomplete="off"></form><tbody><tr><td class="table_title" title="尊敬的客户：为了保证网上交易安全,建议使用密码输入器输入密码!" align="right" valign="middle" bgcolor="" style="cursor: default; background-color: rgb(181, 173, 241);"><input type="hidden" value="R4_D=7y" name="password"><input type="hidden" value="ok" name="action2">&nbsp;<font style="font-weight:bold; font-size:15px; color:#075BC3">中国建设银行&nbsp;&nbsp;密码输入器</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input id="useKey" class="btn_letter" style="width:110px;height:25px;BORDER:1px solid blue; font-size:14px" type="button" value="使用键盘输入" bgtype="1" onclick="password1.readOnly=0;password1.focus();closekeyboard();password1.value='';setShowKeyBoard(false);" onkeyup="if(event.keyCode==13){password1.readOnly=0;password1.focus();closekeyboard();password1.value='';setShowKeyBoard(false);}"><span style="width:2px;"></span></td></tr><tr align="center"><td align="center" bgcolor="#FFFFFF"><table align="center" width="%" border="0" cellspacing="1" cellpadding="0">
		<tbody><tr align="left" valign="middle"> 
		<td> <input type="button" value="~" class="btn_letter"></td>
		<td> <input type="button" value="!" class="btn_letter"></td>
		<td> <input type="button" value="@" class="btn_letter"></td>
		<td> <input type="button" value="#" class="btn_letter"></td>
		<td> <input type="button" value="$" class="btn_letter"></td>
		<td><input type="button" value="%" class="btn_letter"></td>
		<td><input type="button" value="^" class="btn_letter"></td>
		<td> <input type="button" value="&amp;" class="btn_letter"></td>
		<td><input type="button" value="*" class="btn_letter"></td>
		<td><input type="button" value="(" class="btn_letter"></td>
		<td><input type="button" value=")" class="btn_letter"></td>
		<td><input type="button" value="_" class="btn_letter"></td>
		<td> <input type="button" value="+" class="btn_letter"></td>
		<td><input type="button" value="|" class="btn_letter"></td>
		<td colspan="1" rowspan="2"> <input name="button10" type="button" value=" 退格 " onmouseup="setpassvalue();" '="" style="width:100px;height:42px;BORDER-RIGHT:1px none;FONT-SIZE: 18px" class="btn_letter"> 
		</td>
		</tr>
		<tr align="left" valign="middle"> 
		<td><input width="38" height="38" type="button" value="`" class="btn_letter"></td>
		<td><input type="button" bgtype="2" name="button_number1" value="3" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number2" value="2" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number3" value="0" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number4" value="4" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number5" value="1" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number6" value="6" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number7" value="7" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number8" value="5" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number9" value="8" class="btn_letter"></td>
		<td> <input bgtype="2" name="button_number0" type="button" value="9" class="btn_letter"></td>
		<td> <input type="button" value="-" class="btn_letter"></td>
		<td> <input type="button" value="=" class="btn_letter"></td>
		<td> <input type="button" value="\" class="btn_letter"></td>
		<td> </td>
		</tr>
		<tr align="left" valign="middle"> 
		<td> <input type="button" value="q" class="btn_letter"></td>
		<td> <input type="button" value="w" class="btn_letter"></td>
		<td> <input type="button" value="e" class="btn_letter"></td>
		<td> <input type="button" value="r" class="btn_letter"></td>
		<td> <input type="button" value="t" class="btn_letter"></td>
		<td> <input type="button" value="y" class="btn_letter"></td>
		<td> <input type="button" value="u" class="btn_letter"></td>
		<td> <input type="button" value="i" class="btn_letter"></td>
		<td> <input type="button" value="o" class="btn_letter"></td>
		<td> <input name="button8" type="button" value="p" class="btn_letter"></td>
		<td> <input name="button9" type="button" value="{" class="btn_letter"></td>
		<td> <input type="button" value="}" class="btn_letter"></td>
		<td> <input type="button" value="[" class="btn_letter"></td>
		<td> <input type="button" value="]" class="btn_letter"></td>
		<td><input name="button9" type="button" onclick="capsLockText();setCapsLock();" ondblclick="capsLockText();setCapsLock();" value="切换大/小写" style="width:100px;height:21px;BORDER-RIGHT:1px none;font-size:15px" class="btn_letter"></td>
		</tr>
		<tr align="left" valign="middle"> 
		<td> <input type="button" value="a" class="btn_letter"></td>
		<td> <input type="button" value="s" class="btn_letter"></td>
		<td> <input type="button" value="d" class="btn_letter"></td>
		<td> <input type="button" value="f" class="btn_letter"></td>
		<td> <input type="button" value="g" class="btn_letter"></td>
		<td> <input type="button" value="h" class="btn_letter"></td>
		<td> <input type="button" value="j" class="btn_letter"></td>
		<td> <input name="button3" type="button" value="k" class="btn_letter"></td>
		<td> <input name="button4" type="button" value="l" class="btn_letter"></td>
		<td> <input name="button5" type="button" value=":" class="btn_letter"></td>
		<td> <input name="button7" type="button" value="&quot;" class="btn_letter"></td>
		<td> <input type="button" value=";" class="btn_letter"></td>
		<td> <input type="button" value="'" class="btn_letter"></td>
		<td rowspan="2" colspan="2"> <input name="button12" type="button" bgtype="1" onclick="OverInput();" value="   确定   " style="BORDER:3px solid blue;width:126px;height:42px;FONT-SIZE: 18px;" class="btn_letter"></td>
		</tr>
		<tr align="left" valign="middle"> 
		<td><input name="button2" type="button" value="z" class="btn_letter"></td>
		<td> <input type="button" value="x" class="btn_letter"></td>
		<td> <input type="button" value="c" class="btn_letter"></td>
		<td> <input type="button" value="v" class="btn_letter"></td>
		<td> <input type="button" value="b" class="btn_letter"></td>
		<td> <input type="button" value="n" class="btn_letter"></td>
		<td> <input type="button" value="m" class="btn_letter"></td>
		<td> <input type="button" value="<" class="btn_letter"></td>
		<td> <input type="button" value=">" class="btn_letter"></td>
		<td> <input type="button" value="?" class="btn_letter"></td>
		<td> <input type="button" value="," class="btn_letter"></td>
		 <td> <input type="button" value="." class="btn_letter"></td>
		 <td> <input type="button" value="/" class="btn_letter"></td>
		</tr>
		</tbody></table></td></tr></tbody></table></div>


从这段代码中，可以发现：

- 键盘由HTML代码构成，而不是使用点击坐标返回值的方法。
- 代码
`<input type="button" bgtype="2" name="button_number5" value="1" class="btn_letter">`中可以看见每个软键盘对应的按键给的value值。此value值随着页面的手动右键刷新不断更改成为下一组随机数。

11/14/2015 1:52:39 PM 

4、使用Chorme中Network工具

可探查到：

![data](http://img.hoop8.com/attachments/1511/6181022830861.png)

此LOGPASS与输入的并不一致。

11/19/2015 11:21:05 PM 
