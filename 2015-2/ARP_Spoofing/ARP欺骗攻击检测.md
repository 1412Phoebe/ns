#检测终端ARP缓存投毒者#
###检测终端用户的ARP缓存表

假如主机A要与目的主机B进行通信，为了查找与目的主机IP地址相对应的MAC地址，主机A使用ARP协议来查找目的主机B的MAC地址。首先， 源主机A会以广播的形式发送一个ARP请求数据包给以太网上的每一台主机，这个过程称为ARP广播。而在接收到ARP广播的所有计算机中，只有 具有目的主机IP地址的主机B收到该广播报文后，才会向源主机A回送一个包含其MAC地址的应答，这样一次正常的地址解析过程就完成了。为 了尽量减少网络中ARP广播请求的次数，每台主机都拥有一个ARP缓存，这个缓存存放了自主机启动以来所有的IP地址与MAC地址之间的映射记 录。主机每隔一定时间或者每当收到ARP应答，都会用新的地址映射记录对ARP缓存进行更新，以保证自己拥有最新的地址解析缓存。

利用ARP协议的缓存更新不需要验证的特点，就可以冒用一个合法IP，对同网络的数据进行嗅探，而这正是ARP欺骗病毒所采用的手段.

通过arp -a 命令来发现异常ARP缓存记录,从而检测出攻击主机的MAC地址。
###发送ARP请求包
ARP请求报文中含有源主机的IP地址和MAC地址，以及目的主机的IP地址。当该报文通过广播方式到达目的主机时，目的主机会响应该请求，并返回ARP响应报文，从而元主机可以获取目的主机的MAC地址，同样目的主机也能够获得源主机的MAC地址。经过ARP协议解析IP地址之后，主机会在缓存中保存IP地址和MAC地址的映射条目，此后再进行数据交换时只要从缓存中读取映射条目即可。

因为工作于混杂模式的网卡会响应ARP请求数据包，且该网卡的操作系统内核会自动回应该ARP请求数据包。所以可以采用发送伪造的ARP请求包来检测该局域网中工作于混杂模式的网卡，从而定位该网卡所在的主机。伪造的ARP请求包应当设置正确的IP地址错误目的MAC地址。

目的MAC地址的设置可以参考如下设置：

- 对于不同的操作系统，对ARP广播包的处理方式有差异

   - 
虚假广播消息:

       **B47:**FF:FF:FF:FF:FF:FF:FF:FE 

       **B16:**FF:FF:00:00:00:00:00:00 

       **B8:**FF:00:00:00:00:00:00:00 

       **B4:**F0:00:00:00:00:00:00:00 

- 不同操作系统的内核过滤机制有差异

  - 
虚假组播消息:

       **Gr:**01:00:00:00:00:00:00:00 

       **M0:**01:00:5E:00:00:00:00:00 

       **M1:**01:00:5E:00:00:00:00:01

       **M2:**01:00:5E:00:00:00:00:02 

     **M3:**01:00:5E:00:00:00:00:03 

![](http://i.imgur.com/Tld1a9K.png)
正常模式：左侧 混杂模式：右侧

O合法响应,X非法响应,--无响应

正常情况下，网卡检测是不是广播地址要比较看收到的目标MAC地址是否等于ff：ff：ff：ff：ff：ff，是则认为是广播地址。工作于混杂模式时，网卡检测是不是广播地址只看收到的包的目的MAC地址的部分比特位的值，若符合条件则认为是广播地址，利用这点细微差别可以检测出工作于混杂模式的网卡。

Linux环境下，当混杂模式时，每个包都被传到了操作系统内核处理。在处理某些包时，只看IP地址时，而不看目的MAC地址。所以使用一个不存在的目的MAC，正确的IP地址，受影响的内核将会由于是混杂模式而处理它，并将之交给系统堆栈处理，从而实现检测。
  
#检测交换机DoS攻击

交换机主动学习局域网中主机的MAC地址，并建立和维护端口和MAC地址的对应表以此建立交换路径，这个表就是通常我们所说的CAM表。CAM表的大小是固定的，不同的交换机的CAM表大小不同。交换机DoS攻击是指利用工具不断发送去往未知目的地的数据帧，从而快速填满CAM表。当交换机CAM表被填满后，迫使交换机退化为HUB，进广播状态，使内网由交换式网络退化成共享式网络。内网中的嗅探者又可以对网络进行监听。

系统通过启用交换机的端口镜像，来检测交换机的出现异常行为的端口。异常行为如下：



1. 链路通信质量参数：丢包率/重传率
       


2. 未知MAC地址

#检测交换机投毒者


交换机里面有一张CAM表，记录了Mac－Port信息。所谓欺骗交换机缓存，就是修改这张CAM表以达到欺骗交换机的目的！比如现在有一个4端口的交换机，它的CAM表如下：

11-11-11-11-11-11  -- port1；22-22-22-22-22-22  -- port2；33-33-33-33-33-33  -- port3 
  
现在位于port1的主机A（IP是192.168.1.3，MAC地址为11-11-11-11-11-11）想要嗅探位于port2的主机B（IP是192.168.1.4，MAC地址为22-22-22-22-22-22）。实现流程如下：

主机A对外发送一个数据包，如下：

SrcIP:192.168.1.3 ScrMac:22-22-22-22-22-22

DstIP:xxx.xxx.xxx.xxx（随便写），DstMac:xx-xx-xx-xx-xx-xx（随便写）

此时，交换机收到这个包，发现在原来CAM里面，port1对应的机器MAC地址是11-11-11-11-11-11，现在变为：22-22-22-22-22-22，则更新CAM表

更新后的交换机CAM表如下：

22-22-22-22-22-22  -- port1；22-22-22-22-22-22  -- port2；33-33-33-33-33-33  -- port3 

在处于PORT 3的主机向port 2的主机发送数据时，在查询port1时，发现此端口对应MAC地址和数据包里的MAC地址相同，交换机直接就把包转发到port1的主机了。同理，攻击主机还需要对将port 1对应的MAC地址进行相同的处理，最后变成33-33-33-33-33-33，这时攻击主机又可以获得处于PORT 2的主机向处于port 3的主机发送的数据包。

当同一个MAC地址反复被映射到不同物理端口，可视为交换机CAM表中存在异常更新记录。系统应当能检测出系统的异常更新行为。
