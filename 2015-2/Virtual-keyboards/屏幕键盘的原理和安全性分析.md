# 逆向分析/点评 #
----------
10/22/2015 12:39:52 PM
### 屏幕键盘的原理和安全性分析 ###

分析对象至少应包含以下2家：

- 中传的一卡通在线充值转账系统
- 建设银行个人网银登录

对比直接使用物理键盘方式输入密码，屏幕键盘是否改进了安全性？请详细阐述理由。

### 安全背景 ###

翻译自wiki百科：

虚拟键盘（Virtual keyboards）可以用于降低键盘监听（keystroke logging）的风险。例如，西太平洋的网上银行服务使用虚拟键盘输入密码，如treasurydirect。

![treasurydirect](http://upload.wikimedia.org/wikipedia/en/thumb/f/fa/TreasuryDirectLoginScreen.PNG/695px-TreasuryDirectLoginScreen.PNG)

对于恶意软件（malware）来说，他们想要通过监测显示和鼠标来获取虚拟键盘的输入比监测真正的键盘困难很多。但是这种监控也是可以实现的，比如在有规律的时间间隔内记录屏幕截图或每一次鼠标的点击。

使用鼠标点击网络屏幕键盘，可能会增加用户密码泄露的风险，如肩窥（shoulder surfing）。
> 肩窥（shoulder surfing）指使用直接的观察技术，如通过某人的肩膀来查看，来获取信息。在款台刷卡结账时，排在后面的顾客多半会后退一步，主动回避。可有些人偏偏就要凑上来看你输密码，实在让人无法忍受。这种行为英语里叫做shoulder surfing.

一个窥视者通常看屏幕比看键盘更容易，可以看到鼠标移向了哪些字符。一些屏幕键盘也许会给出一些视觉反馈，比如点击的时候颜色会出现变化。最坏的情况下，最近点击的一个键会持续给出反馈，直到点击下一个键被点击。一个用户可能不能够“确定和点击”的和在实际键盘上一样快，所以这也为窥视者提供了便利条件。

###对象背景###
**一、中传的一卡通在线充值转账系统**

1、一卡通在线充值转账系统情况概述：

校园卡电子服务平台 [http://ykt.cuc.edu.cn/](http://ykt.cuc.edu.cn/)
用校外网无法登录此电子服务平台。校园卡电子服务平台未加密，为http协议，登录时使用CAS认证。
> CAS = Central Authentication Service，中央认证服务，一种独立开始指令协议。CAS 是 Yale 大学发起的一个开源项目，旨在为 Web 应用系统提供一种可靠的单点登录方法，CAS 在 2004 年 12 月正式成为 JA-SIG 的一个项目。
> ![CAS认证](http://b.hiphotos.baidu.com/baike/c0%3Dbaike180%2C5%2C5%2C180%2C60/sign=fff8c229b9014a9095334eefc81e5277/f3d3572c11dfa9ec6bfc2b8c62d0f703908fc15f.jpg)
> 从结构上看，CAS 包含两个部分： CAS Server 和 CAS Client。CAS Server 需要独立部署，主要负责对用户的认证工作；CAS Client 负责处理对客户端受保护资源的访问请求，需要登录时，重定向到 CAS Server。

2、校园卡电子服务平台登录界面：

![校园卡电子服务平台登录界面](http://7xo6vj.com1.z0.glb.clouddn.com/15-11-12/15318691.jpg)

3、软键盘安全性：

连续刷新十次，得到不同的软键盘：

1. 9721685430
2. 7613095824
3. 2831406975
4. 2367904158
5. 1836450297
6. 5179482630
7. 9816235704
8. 1873526490
9. 9524378610
10. 9182034675

可以看到，每次软键盘数字的排列都是随机打乱的。

    由chorme开发者工具得到的代码：

    <p id="p_cxmm" class="cardTransferInfo">
        <label>
            查询密码：</label>
        <input type="password" id="Password" name="password" readonly="readonly" maxlength="6" class="validate[required,minSize[6],maxSize[6]]" style="background-color:#f99; border:#f00 1px solid;"><span class="red">*(校园卡查询密码)</span></p>
    <div class="virtualKey" id="password_key_transfer" style="">
        <img src="/Account/GetNumKeyPadImg" alt="密码键盘" usemap="#keyboardMapForPwd" width="300" height="61">
        <map name="keyboardMapForPwd" id="keyboardMapForPwd">
            <area shape="rect" coords="4,3,29,28" value="0">
            <area shape="rect" coords="33,3,58,28" value="1">
            <area shape="rect" coords="62,3,88,28" value="2">
            <area shape="rect" coords="92,3,118,28" value="3">
            <area shape="rect" coords="122,3,148,28" value="4">
            <area shape="rect" coords="152,3,178,28" value="5">
            <area shape="rect" coords="182,3,207,28" value="6">
            <area shape="rect" coords="211,3,236,28" value="7">
            <area shape="rect" coords="241,3,266,28" value="8">
            <area shape="rect" coords="270,3,295,28" value="9">
            <area shape="rect" coords="5,33,74,148" value="Backspace">
            <area shape="rect" coords="78,33,221,148" value="Clear">
            <area shape="rect" coords="227,33,295,148" value="Close">
        </map>
    </div>
    

从这段代码中，可以发现：

- 密码键盘不是真正可点击键盘，而是一个图像，其地址为：/Account/GetNumKeyPadImg。浏览器中输入此地址，是不可以看到相应图像键盘的。
- 代替键盘输入的方式，是用shape、coords等HTML元素规定区域的尺寸、形状和位置，点击坐标区域给出相应value。

4、使用Chorme中Network工具

可探查到：

![data](http://image17-c.poco.cn/mypoco/myphoto/20151126/11/17868435620151126113627029_640.jpg?330x109_130)

此passord与输入的并不一致。

可探测到Cookie：

![cookie](http://image17-c.poco.cn/mypoco/myphoto/20151126/11/17868435620151126113456058_640.jpg?894x385_130)

5、测试：
①密码输入正确的情况：
General:
Remote Address:202.205.25.18:80
Request URL:http://ykt.cuc.edu.cn/CardManage/CardInfo/TransferAccount
Request Method:POST
Status Code:200 OK

>200请求成功 303重定向 400请求错误 401未授权 
>403禁止访问 404文件未找到 500服务器错误

Response Headers:
Cache-Control:private
Content-Length:55
Content-Type:application/json; charset=utf-8
Date:Thu, 26 Nov 2015 03:57:47 GMT
Server:Microsoft-IIS/7.5
X-AspNet-Version:4.0.30319
X-AspNetMvc-Version:3.0
X-Powered-By:ASP.NET

**view source:**
HTTP/1.1 200 OK
Cache-Control: private
Content-Type: application/json; charset=utf-8
Server: Microsoft-IIS/7.5
X-AspNetMvc-Version: 3.0
X-AspNet-Version: 4.0.30319
X-Powered-By: ASP.NET
Date: Thu, 26 Nov 2015 03:57:47 GMT
Content-Length: 55

Request Headers:
Accept:*/*
Accept-Encoding:gzip, deflate
Accept-Language:zh-CN,zh;q=0.8
Connection:keep-alive
Content-Length:81
Content-Type:application/x-www-form-urlencoded
Cookie:ASP.NET_SessionId=1fj4eivlu2cgee3onxpy5c1g; iPlanetDirectoryPro=U3luU25vXzIwMTMxMTEyMzAyN18yMDE1MTEyNjExNTY1MDQ4MTA%3d
Host:ykt.cuc.edu.cn
Origin:http://ykt.cuc.edu.cn
Referer:http://ykt.cuc.edu.cn/
User-Agent:Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36
X-Requested-With:XMLHttpRequest

**view source:**
POST /CardManage/CardInfo/TransferAccount HTTP/1.1
Host: ykt.cuc.edu.cn
Connection: keep-alive
Content-Length: 81
Accept: */*
Origin: http://ykt.cuc.edu.cn
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Referer: http://ykt.cuc.edu.cn/
Accept-Encoding: gzip, deflate

> DEFLATE是同时使用了LZ77算法与哈夫曼编码（Huffman Coding）的一个无损数据压缩算法。
> GZIP最早由Jean-loup Gailly和Mark Adler创建，用于UNⅨ系统的文件压缩。我们在Linux中经常会用到后缀为.gz的文件，它们就是GZIP格式的。现今已经成为Internet 上使用非常普遍的一种数据压缩格式，或者说一种文件格式。


Accept-Language: zh-CN,zh;q=0.8
Cookie: ASP.NET_SessionId=1fj4eivlu2cgee3onxpy5c1g; iPlanetDirectoryPro=U3luU25vXzIwMTMxMTEyMzAyN18yMDE1MTEyNjExNTY1MDQ4MTA%3d

Form Data:
password:499409
checkCode:7383
amt:10.00
fcard:bcard
tocard:card
bankno:
bankpwd:

**view source:**
password=499409&checkCode=7383&amt=10.00&fcard=bcard&tocard=card&bankno=&bankpwd=

**第二次测试：**

Form Data:
password:699679
checkCode:3274
amt:10.00
fcard:bcard
tocard:card
bankno:
bankpwd:

     //index.js
     //校园卡转账
    $("#Pay #Transfer").click(function () { LoadDiv($("#Payment"), "/CardManage/CardInfo/Transfer", { needHeader: false }); });
     //一卡通收费
    $("#Pay #yktCharge").click(function () { LoadDiv($("#Payment"), "/AutoPay/PlatformFee/NeedItem", { needHeader: false }); });


     //jq.syn.common.js
    //公用方法
	(function () {
	
	    // window.onunload($.post(););
	    //字符串trim
	    String.prototype.trim = function () {
	        return this.replace(/(^\s*)|(\s*$)/g, "");
	    };
	    String.prototype.ltrim = function () { //删除左边的空格
	        return this.replace(/(^\s*)/g, "");
	    };
	    String.prototype.rtrim = function () { //删除右边的空格
	        return this.replace(/(\s*$)/g, "");
	    };
	
	    String.prototype.byteLength = function () {//获取字符串长度，汉字为2个字节程度
	        return this.replace(/[^\x00-\xff]/g, "**").length;
	    }
	
	
	    Number.prototype.toTwoDecimal = function () {
	        var f_x = this;
	        if (isNaN(f_x)) {
	            return "0.00";
	        }
	        else {
	            if (parseFloat(f_x) > 999999999) {
	                return 999999999;
	                $.syn.alert({ content: "最大为999999999" });
	            }
	            else {
	                f_x = Math.round(f_x * 100) / 100;
	                var s_x = f_x.toString();
	                var pos_decimal = s_x.indexOf('.');
	                if (pos_decimal < 0) {
	                    pos_decimal = s_x.length;
	                    s_x += '.';
	                }
	                while (s_x.length <= pos_decimal + 2) {
	                    s_x += '0';
	                }
	                if (parseFloat(s_x) < 0) {
	                    s_x = "0.00";
	                }
	                return s_x;
	            }
	        }
	    }
	
	    //日志
	    this.log = function (msg) {
	        if (!window.console || !console) {
	            return;
	        }
	        if (window.console || console.firebug) {
	            console.log("%s", msg);
	        }
	    };
	    //动态加入CSS链接
	    this.addCssLink = function (url, media) {
	        if (document.createStyleSheet) {
	            document.createStyleSheet(url);
	        }
	        else {
	            var newSS = document.createElement('link');
	            newSS.rel = 'stylesheet';
	            newSS.type = 'text/css';
	            newSS.media = media || "all";
	
	            newSS.href = url;
	            document.getElementsByTagName("head")[0].appendChild(newSS);
	        }
	    };
	    //消息，便于页面上显示消息提示
	    this.showMsg = function (ctl, msg, flag) {
	        ctl.fadeIn("fast");
	        ctl.text(msg);
	        ctl.removeClass();
	        if (flag) {
	            ctl.addClass("rightResult");
	        }
	        else {
	            ctl.addClass("errorResult");
	        }
	    };
	    //隐藏消息提示
	    this.hideMsg = function (ctl, time) {
	        setTimeout(function () {
	            ctl.text("");
	            ctl.hide();
	        }, time || 0);
	    };
	    //切换样式
	    this.changeClass = function (ctl, styles) {
	        ctl.removeClass();
	        ctl.addClass(styles);
	    };
	
	    this.waitingevents = {};
	    this.SynWaiting = function (opts) {
	        var conf = $.extend({
	            dialogtype: "confirm",
	            title: "请稍后……",
	            content: "<img src='/images/system/horizontal_loader.gif' />",
	            width: 240,
	            height: 150,
	            hasbuttons: {}
	        }, opts);
	        waitingevents
	        $.jqDialog(conf);
	    }
	    //消息提示框，当前浏览器中只允许弹出一个该框
	    this.SynAlert = function (opts) {
	        var conf = $.extend({
	            dialogtype: "alert",
	            title: "提示",
	            width: 300,
	            height: 200,
	            hasbuttons: { 'cancel': '关闭' }
	        }, opts);
	        $.jqDialog(conf);
	    }
	    //获取radio(input type=radio)元素
	    this.getRadios = function (name) {
	        return $(":radio[name='" + name + "']");
	    }
	    //获取input type=radio的当前值
	    this.getRadioValue = function (name) {
	        return $(":radio[name='" + name + "']:checked").val();
	    };
	    //获取select的当前值
	    this.getSelectValue = function (id) {
	        return $("select[id='" + id + "'] option:checked").val();
	    };
	    //获取input type=checkbox的当前值
	    this.getCheckboxValue = function (name) {
	        var ret = new Array();
	        $(":checkbox[name='" + name + "']:checked").each(function (i) {
	            ret.push($(this).val());
	        })
	        return ret.join(",");
	    };
	    //在新窗口打开页面
	    this.RedirectToNewPage = function (url, data, fn) {
	        if (!$.isEmptyObject(data)) {
	            url += "?" + $.param(data);
	        }
	        window.open(url, '', 'scrollbars=yes,resizable=yes');
	        if (fn) fn();
	    }
	    this.RedirectTo = function (url, data, fn) {
	        if (!$.isEmptyObject(data)) {
	            url += "?" + $.param(data);
	        }
	        window.location.href = url;
	        if (fn) fn();
	    }
	
	    this.LoadDiv = function (div, url, data, fn) {
	        $(div).empty();
	        if ($(div).css("display") == "none") {
	            $(div).show();
	        }
	        //$(div).attr('style', 'width:100%;height:100%');
	        $(div).append("<div style='width:100%;height:100%;text-align:center'><img style='clear:both' src='/Images/System/loading.gif' /></div>");
	        $(div).load(url, data, fn);
	    }
	    //一般用于分页，且在传参时，url与data只能取其一
	    this.LoadHtml = function (div, url, data, fn) {
	        if (!$.isEmptyObject(data)) {
	            url += "?" + $.param(data);
	        }
	        $(div).empty();
	        if ($(div).css("display") == "none") {
	            $(div).show();
	        }
	        $(div).append("<div style='width:100%;height:100%;text-align:center'><img style='clear:both' src='/Images/System/loading.gif' /></div>");
	
	        $.get(url, function (data) {
	            $(div).html(data);
	            if (fn) fn();
	        })
	    }
	
	    this.CheckSomething = function (ctrl, url, data, fn) {
	        $(ctrl).hide();
	        $(ctrl).next().remove();
	        $(ctrl).after("<div id=divCheckingSomethingOf" + $(ctrl).attr('id') + "><span></span><img src=/Images/System/gif_loading_small2.gif /></div>");
	        $.get(url, data, function (data) {
	            $(ctrl).next().find("span").text(data.msg);
	            if (data.ret) {
	                $(ctrl).next().find("img").attr("src", "/Images/System/gif_yes.gif");
	            } else {
	                $(ctrl).next().find("img").attr("src", "/Images/System/gif_no.gif");
	            }
	            if (fn) fn(data);
	            setTimeout(function () { (ctrl).next().remove() }, 3000);
	            $(ctrl).show();
	
	        });
	    }
	
	    //打印
	    this.doPrint = function () {
	        bdhtml = $("body").html(); ;
	        sprnstr = "<!--startprint-->";
	        eprnstr = "<!--endprint-->";
	        prnhtml = bdhtml.substr(bdhtml.indexOf(sprnstr) + 17);
	        prnhtml = prnhtml.substring(0, prnhtml.indexOf(eprnstr));
	        $("body").html(prnhtml);
	        this.print();
	        $("body").html(bdhtml);
	    }
	    //确认消息提示框，当前浏览器中只允许弹出一个该框
	    this.SynConfirm = function (opts) {
	        var conf = $.extend({
	            dialogtype: "confirm",
	            title: "确认提示",
	            width: 300,
	            height: 200,
	            hasbuttons: { 'button': '确定', 'cancel': '取消' }
	        }, opts);
	        $.jqDialog(conf);
	    }
	
	
	})();
	//将浮点数四舍五入，取小数点后2位，如果不足2位则补0,这个函数返回的是字符串的格式
	function changeTwoDecimal(htmlCtorl) {
	    var f_x = parseFloat($(htmlCtorl).val().trim());
	    if (isNaN(f_x)) {
	        $(htmlCtorl).val("0.00");
	    }
	    else {
	        if (parseFloat(f_x) > 999999999) {
	            $(htmlCtorl).val(999999999);
	            $.syn.alert({ content: "最大为999999999" });
	        }
	        else {
	            f_x = Math.round(f_x * 100) / 100;
	            var s_x = f_x.toString();
	            var pos_decimal = s_x.indexOf('.');
	            if (pos_decimal < 0) {
	                pos_decimal = s_x.length;
	                s_x += '.';
	            }
	            while (s_x.length <= pos_decimal + 2) {
	                s_x += '0';
	            }
	            if (parseFloat(s_x) < 0) {
	                s_x = "0.00";
	            }
	            $(htmlCtorl).val(s_x);
	        }
	    }
	}
	//将浮点数四舍五入，取小数点后4位，如果不足4位则补0,这个函数返回的是字符串的格式
	function changeFourFloat(htmlCtorl) {
	    var f_x = parseFloat($(htmlCtorl).val().trim());
	    if (isNaN(f_x)) {
	        $(htmlCtorl).val("0.0000");
	    }
	    else {
	        if (parseFloat(f_x) > 999999999) {
	            $(htmlCtorl).val(999999999);
	            $.syn.alert({ content: "最大为999999999" });
	        }
	        else {
	            f_x = Math.round(f_x * 10000) / 10000;
	            var s_x = f_x.toString();
	            var pos_decimal = s_x.indexOf('.');
	            if (pos_decimal < 0) {
	                pos_decimal = s_x.length;
	                s_x += '.';
	            }
	            while (s_x.length <= pos_decimal + 2) {
	                s_x += '0';
	            }
	            if (parseFloat(s_x) < 0) {
	                s_x = "0.0000";
	            }
	            $(htmlCtorl).val(s_x);
	        }
	    }
	}
	////获取UTC日期（这个方法不提倡使用，方法是对的。只是在ManageIndex.js下有使用，所以不忍心删除。如果想用，就用下面那个日期的扩展方法(Date.prototype.format)，你懂的）
	//function GetFormatDateTime(offDate) {
	//    var year = offDate.substring(0, offDate.indexOf("-"));
	//    offDate = offDate.substr(offDate.indexOf("-") + 1);
	//    var month = offDate.substring(0, offDate.indexOf("-"));
	//    offDate = offDate.substr(offDate.indexOf("-") + 1);
	//    var day = offDate.substring(0, offDate.indexOf(" "));
	//    offDate = offDate.substr(offDate.indexOf(" ") + 1);
	//    var hour = offDate.substring(0, offDate.indexOf(":"));
	//    offDate = offDate.substr(offDate.indexOf(":") + 1);
	//    var mi = offDate.substring(0, offDate.indexOf(":"));
	//    offDate = offDate.substr(offDate.indexOf(":") + 1);
	//    var sec = offDate;
	//    //var d = Date.UTC(year, parseInt(month, 10) - 1, day, hour, mi, sec);
	//    var d = new Date();
	//    d.setFullYear(year, parseInt(month, 10) - 1, day);
	//    d.setHours(hour, mi, sec);
	//    return d;
	//}
	Date.prototype.format = function (format) {
	    var o = {
	        "M+": this.getMonth() + 1, //month
	        "d+": this.getDate(),    //day
	        "h+": this.getHours(),   //hour
	        "m+": this.getMinutes(), //minute
	        "s+": this.getSeconds(), //second
	        "q+": Math.floor((this.getMonth() + 3) / 3),  //quarter
	        "S": this.getMilliseconds() //millisecond
	    }
	    if (/(y+)/.test(format)) format = format.replace(RegExp.$1,
	 (this.getFullYear() + "").substr(4 - RegExp.$1.length));
	    for (var k in o) if (new RegExp("(" + k + ")").test(format))
	        format = format.replace(RegExp.$1,
	 RegExp.$1.length == 1 ? o[k] :
	 ("00" + o[k]).substr(("" + o[k]).length));
	    return format;
	}
	
	
	/* 得到日期年月日等加数字后的日期 */
	Date.prototype.dateAdd = function (interval, number) {
	    var d = this;
	    var k = { "y": "FullYear", "q": "Month", "m": "Month", "w": "Date", "d": "Date", "h": "Hours", "n": "Minutes", "s": "Seconds", "ms": "MilliSeconds" };
	    var n = { "q": 3, "w": 7 };
	    eval("d.set" + k[interval] + "(d.get" + k[interval] + "()+" + ((n[interval] || 1) * number) + ")");
	    return d;
	}
	/* 计算两日期相差的日期年月日等 */
	Date.prototype.dateDiff = function (interval, objDate) {
	    var d = this, t = d.getTime(), t2 = objDate.getTime(), i = {};
	    i["y"] = objDate.getFullYear() - d.getFullYear();
	    i["q"] = i["y"] * 4 + Math.floor(objDate.getMonth() / 4) - Math.floor(d.getMonth() / 4);
	    i["m"] = i["y"] * 12 + objDate.getMonth() - d.getMonth();
	    i["ms"] = objDate.getTime() - d.getTime();
	    i["w"] = Math.floor((t2 + 345600000) / (604800000)) - Math.floor((t + 345600000) / (604800000));
	    i["d"] = Math.floor(t2 / 86400000) - Math.floor(t / 86400000);
	    i["h"] = Math.floor(t2 / 3600000) - Math.floor(t / 3600000);
	    i["n"] = Math.floor(t2 / 60000) - Math.floor(t / 60000);
	    i["s"] = Math.floor(t2 / 1000) - Math.floor(t / 1000);
	    return i[interval];
	}
	/*
	interval:类型参数，可为："y":"FullYear", "q":"Month", "m":"Month", "w":"Date", "d":"Date", "h":"Hours", "n":"Minutes", "s":"Seconds", "ms":"MilliSeconds"
	number:对应加上的数值
	var d1 = new Date();
	d1.dateAdd("y" ,1);
	var d2 = new Date();
	alert("相隔了"+ d2.dateDiff("y" ,d1) +"年");
	*/
	
	//判断数据是否输入
	this.CheckEmptyType = function (ctrl, data, Type, str) {
	    var val = $(ctrl).val();
	    $(ctrl).next("#CheckEmptyType").remove();
	    $(ctrl).after("<div id='CheckEmptyType'><span></span><img /></div>");
	    if (val == null || val == "") {
	        $("#CheckEmptyType span").text(data);
	        $("#CheckEmptyType").find("img").attr("src", "/Images/System/gif_no.gif");
	
	
	        //$(ctrl).next("#CheckEmptyType").remove();
	        // $(ctrl).after("<div id='CheckEmptyType'><span>" + data + "</span><img src=/Images/System/gif_no.gif /></div>");
	    }
	    else {
	        //非空验证
	        if (Type == "Num") {
	            //判断数字类型数据
	            if (!isNaN(val)) {
	                $("#CheckEmptyType span").text(" ");
	                $("#CheckEmptyType").find("img").attr("src", "/Images/System/gif_yes.gif");
	            }
	            else {
	                $("#CheckEmptyType span").text(str);
	                $("#CheckEmptyType").find("img").attr("src", "/Images/System/gif_no.gif");
	                //$(ctrl).after("<div id='CheckEmptyType'><span>" + str + "</span><img src=/Images/System/gif_no.gif /></div>");
	
	            }
	            // 判断数字类型数据
	        }
	        //非空验证
	        //当丢失焦点以藏提示
	//        $(ctrl).mouseout(function () {
	//            alert("ss");
	////            var timer = 3000;
	////            setTimeout(timer);
	////            $("#CheckEmptyType span").text(" ");
	////            $("#CheckEmptyType").find("img").removeAttr("src");
	
	//        });
	        //当丢失焦点以藏提示
	
	    }
	}
	
	//验证图片的格式 
	// filename获取侄
	//filetypes需要支持的文件类型 格式jpg,png
	this.parseFileType = function (filename, filetypes) {
	    var types = filetypes.split(',');
	    var _file = filename.split(".");
	    return $.inArray(_file[_file.length - 1].toLowerCase(), types) >= 0;
	}


	
    //jq.syn.dialog.js
	(function ($) {
	    /*
	    Usage Note: 
	    1：can be used in Mvc website
	    2：only single instance in dom always
	    3: it would be stopped while beforesubmit or submit or aftersubmit return false
	    4: it would be stopped while clickbutton return false
	    5: data is binded with url
	    6: it would continue while function beforesubmit was defined and return true 
	    Use Case:
	    ------js-----
	    $.jqDialog({
	    title:'this is test title',
	    content: "this is test dialog",
	    url: '/controller/action',
	    data:{},
	    hasbuttons: { 'submit':'submit','button': 'button', 'cancel': 'cancel' },
	    beforesubmit: function () { },  
	    aftersubmit: function () { },
	    clickbutton: function () { },
	    clickcancel: function () { },
	    loadComplete: function () { }
	    });
	    ------controller/action-----
	    public JsonResult action()
	    {
	    return Json(new { ret = false, msg = "sorry" });
	    }
	
	    */
	
	    $.extend({
	        jqDialog: function (opts) {
	            //设定对话框大小
	            if (opts.hasbuttons['submit'] != undefined && opts['url'] != undefined && opts['url'].length > 3) {
	                if (opts['width'] == undefined)
	                    $(opts).attr('width', 600);
	                if (opts['height'] == undefined)
	                    $(opts).attr('height', 400);
	            } else {
	                if (opts['width'] == undefined)
	                    $(opts).attr('width', 300);
	                if (opts['height'] == undefined)
	                    $(opts).attr('height', 180);
	            }
	            //设定默认值
	            var conf = $.extend({
	                title: "系统信息提示框",
	                url: "",
	                data: null,
	                content: "",
	                autoOpen: true,
	                width: 600,
	                height: 400,
	                modal: true,
	                minWidth: 300,
	                minHeight: 180,
	                resizable: false,
	                zIndex: 3999,
	                beforeClose: function (event, ui) { },
	                beforesubmit: function () { },
	                aftersubmit: function () { },
	                clickbutton: function () { },
	                clickcancel: function () { },
	                loadComplete: function () { }
	            }, opts);
	            //构造对话框div
	            var that = $("#divSynDialog");
	            if (that.length == 0) {
	                var newdiv = document.createElement('div');
	                newdiv.setAttribute("id", "divSynDialog");
	                newdiv.setAttribute("title", conf.title);
	                document.getElementsByTagName("body")[0].appendChild(newdiv);
	                that = $(newdiv);
	            }
	            that.empty();
	            //定义按钮事件
	            var fn_submit = function () {
	                var ret = null;
	                if (opts.beforesubmit) {
	                    ret = ret == undefined ? true : opts.beforesubmit();
	                    ret = ret && checkform();
	                }
	                if (ret) {
	                    $(that).find('form').ajaxSubmit(function (data) {
	                        if (data == null || data == undefined || data.ret) {
	                            if (opts.aftersubmit) {
	                                ret = opts.aftersubmit();
	                                if (ret == null || ret == undefined || ret) {
	                                    fn_cleardialog();
	                                    return false;
	                                };
	                            }
	                        } else {
	                            showmsg($(that).next(), data.msg);
	                        }
	                    });
	                }
	            };
	            var fn_button = function () {
	                if (opts.clickbutton) {
	                    var ret = opts.clickbutton();
	                    if (ret == null || ret == undefined || ret) {
	                        fn_cleardialog();
	                    }
	                }
	                return false;
	            };
	            var fn_cancel = function () {
	                if (opts.clickcancel)
	                    opts.clickcancel();
	                fn_cleardialog();
	            };
	            //显示提示信息
	            var showmsg = function (container, msg) {
	                var ret = $("#syndialogshowmsg");
	                if (ret.length == 0)
	                    $(container).prepend("<div id=syndialogshowmsg>" + msg + "</div>");
	                else $(ret).text(msg);
	            };
	            //清除对话框
	            var fn_cleardialog = function () {
	                $(that).dialog("close");
	                $(that).dialog("destory");
	                $(that).parent().remove();
	            }
	            //添加按钮
	            conf.buttons = new Object();
	            if (conf.hasbuttons['submit'] != undefined)
	                conf.buttons[conf.hasbuttons['submit']] = fn_submit;
	            if (conf.hasbuttons['button'] != undefined)
	                conf.buttons[conf.hasbuttons['button']] = fn_button;
	            if (conf.hasbuttons['cancel'] != undefined)
	                conf.buttons[conf.hasbuttons['cancel']] = fn_cancel;
	            //初始化对话框
	            $(that).dialog(conf);
	            //加载内容
	            if (conf.url.length > 3) {
	                if (conf.data == null)
	                    $(that).load(conf.url, conf.loadComplete);
	                else
	                    $(that).load(conf.url, conf.data, conf.loadComplete);
	            }
	            else $(that).text(conf.content);
	        }
	    });
	})(jQuery);
	
	//jquery 自带验证
	function checkform() {
	    var dataid = $("span[class='field-validation-error']:visible");
	    //var dataid = $("span[class='field-validation-error']:not([style='display:none'])");//也可以
	    if (dataid.html() == null) {
	        return true;
	    }
	    return false;
	}


     //jq.syn.dialog.raw.js
		/*! 
		* @requires jQuery v1.3.2 or later   
		
		模拟 js 原生 alert、confirm、 showModalDialog(待完善) 
		支持 Jquery UI Dialog 原生参数对象所有属性和事件定义
		并在此基础上为了方便调用，扩展了该对象的属性
		
		alert 扩展属性  
		content: 消息内容；
		callBack: 关闭 按钮的 回调函数
		confirm 扩展属性  
		content: 消息内容；
		confirmCallBack: 确定 按钮的 回调函数
		cancelCallBack: 取消 按钮的 回调函数
		
		Use Case:
		------js-----
		Alert Confirm
		
		$.syn.alert({ content: "Alert内容", callBack: function () {
		$.syn.confirm({ content: "content" });
		}
		}); 
		
		showModalDialog
		
		$.syn.showModalDialog({url:url}); 
		
		*/
		jQuery.syn = {
		    panelDiv: function () {
		        var tdiv = $("<div></div>");
		        tdiv.attr("id", "d" + new Date().getTime());
		        return tdiv;
		    },
		    alert: function (options) {
		        var defaults = {
		            height: 'auto',
		            title: '提示',
		            modal: true,
		            buttons: { "关闭": function () { real.callBack(); $(this).dialog("close"); } },
		            close: function (event, ui) { $(this).dialog("destroy").remove() },
		            content: '……', //消息内容
		            callBack: function () { } //关闭 按钮的 回调函数
		        };
		
		        var real = $.extend(defaults, options);
		
		        var panel = $.syn.panelDiv();
		        panel.html(real.content);
		        panel.dialog(real);
		    },
		    confirm: function (options) {
		        var defaults = {
		            height: 'auto',
		            title: '提示',
		            modal: true,
		
		            close: function (event, ui) { $(this).dialog("destroy").remove() },
		            content: '……', //消息内容
		            confirmCallBack: function () { }, //确定 按钮的 回调函数
		            cancelCallBack: function () { } //取消 按钮的 回调函数
		        };
		
		        var real = $.extend(defaults, options);
		
		        var panel = $.syn.panelDiv();
		
		        panel.html("<br/>" + real.content);
		
		        real.buttons = {
		            "确定": function () { real.confirmCallBack(); $(this).dialog("close"); },
		            "取消": function () { real.cancelCallBack(); $(this).dialog("close"); }
		        };
		
		        panel.dialog(real);
		    },
		
		    showModalDialog: function (options) {
		        var defaults = {
		            height: 'auto',
		            title: 'ModalDialog',
		            modal: true,
		            close: function (event, ui) { $(this).dialog("destroy").remove() },
		            buttons: {
		                "确定": function (data) { },
		                "取消": function () { $(this).dialog("close"); }
		            },
		            uri: '/', //要加载的远程地址
		            autoSubmit: true, //是否响应指定按钮的自动提交
		            autoSubmitBtnIndex: 0, //要自动提交的按钮索引 在 buttons 中 从 0 开始 
		            beforeSubmit: function () { return true; }, //自动提交前执行 Return: True 提交; false 取消提交
		            afterSubmit: function () { $(this).dialog("close"); } //提交后回调回调函数 
		        };
		
		        var real = $.extend(defaults, options);
		
		        var panel = $.syn.panelDiv();
		        var isxss = real.uri.substr(0, 7).toUpperCase() === "HTTP://";
		        if (isxss) {
		            real.buttons = null;
		            panel.html('<iframe id="ifr_center" frameborder="0" width="100%" height="100%" src="' + real.uri + '"></iframe>');
		        } else {
		            if (real.autoSubmit) {
		                var btns = new Array();
		                var objBtns = real.buttons;
		                for (var item in objBtns) {
		                    btns.push({ text: item, click: objBtns[item] });
		                }
		
		                real.buttons = btns;
		
		                if (real.buttons.length > real.autoSubmitBtnIndex) {
		                    var rawFun = real.buttons[real.autoSubmitBtnIndex].click;
		                    real.buttons[real.autoSubmitBtnIndex].click = function () {
		                        if (real.beforeSubmit()) {
		                            var t = $(this);
		                            panel.find('form').attr("action", real.uri).ajaxSubmit(function (data) {
		                                rawFun.call(t, data);
		                                real.afterSubmit.call(t, data);
		                            }); 
		                        }
		                    }
		                }
		            }
		            panel.load(real.uri);
		        }
		        panel.dialog(real);
		    }
		} 



**二、建设银行个人网银登录**

1、建设银行个人网银登录情况概述：

中国建设银行个人网上银行可用任何网络登录。使用https全站加密。
 [https://ibsbjstar.ccb.com.cn/app/V5/CN/STY1/login.jsp?UDC_CUSTOMER_ID=&UDC_CUSTOMER_NAME=&UDC_COOKIE=55db7a7686c3567fovXFSTsXQwrDHKJbu3Gi1447316596250oAeRkYNfiXp211LrdCCg6adec1ee677022fc1c1a341abebc2f14&UDC_SESSION_ID=ZT1EMzx79kGMLjQac5484c63d48-20151112162319](https://ibsbjstar.ccb.com.cn/app/V5/CN/STY1/login.jsp?UDC_CUSTOMER_ID=&UDC_CUSTOMER_NAME=&UDC_COOKIE=55db7a7686c3567fovXFSTsXQwrDHKJbu3Gi1447316596250oAeRkYNfiXp211LrdCCg6adec1ee677022fc1c1a341abebc2f14&UDC_SESSION_ID=ZT1EMzx79kGMLjQac5484c63d48-20151112162319)

2、中国建设银行个人网上银行登录界面：

![建设银行个人网银登录界面](http://7xo6vj.com1.z0.glb.clouddn.com/15-11-12/83407004.jpg)

3、软键盘安全性：

打开软键盘后的界面：

![建设银行个人网银软键盘](http://7xo6vj.com1.z0.glb.clouddn.com/15-11-12/87155860.jpg)

连续刷新十次，得到不同的软键盘：

1. 1074569823
2. 3694157802
3. 7248156093
4. 1936508274
5. 1834207695
6. 8624537109
7. 7134502698
8. 4520937816
9. 4230587196
10. 1052476893

11/12/2015 10:08:30 PM 

可以看到，每次软键盘数字的排列都是随机打乱的。

    由chorme开发者工具得到的代码：

    <tr>
	<td class="tar">登录密码：</td>
	<td>

	 <input style="vertical-align:middle;width:154px;" name="LOGPASS" id="LOGPASS" type="password" autocomplete="off" size="20" minlength="6" maxlength="12" title="登录密码" onchange="$('Calc').password.value=this.value;
	 keyJiami(this);" onfocus="if($('softkeyboard').style.display == 'none'){ if(isShowKeyboard()){this.value = ''; 
	 password1=this; showkeyboard(); this.readOnly=1; $('Calc').password.value='';} if(useSoftBoard){this.value = '';
	 useSoftBoard = false;}}" readonly=""> 
	
     <!--软键盘 开始-->
                     
     <div id="span0" class="rujian1" title="软键盘指软件模拟键盘，您可以通过鼠标点击输入字符，防止木马记录键盘输入的密码。" onclick="if (true) { $('LOGPASS').value = ''; password1 = $('LOGPASS'); showkeyboard(); $('LOGPASS').readOnly = 1; $('Calc').password.value = ''; };">
     <img src="/V5/images5/softkeyboard.gif" width="56" height="18" border="0" alt="" id="img_id">
     </div>
                            
     <script>

       try {	 
            var isCurrIE6=(navigator.userAgent.toLowerCase().indexOf("msie 6.0") != -1);
            var isCurrIE7=(navigator.userAgent.toLowerCase().indexOf("msie 7.0") != -1);
            //IE6特殊处理
            if(isCurrIE6)	{
                                document.getElementById("span0").className = "ruanjian"; 
                                var obj=document.getElementById("icon_event");
                            	obj.attachEvent("onmouseover",function(){ document.getElementById("icon_pop").style.display = "block"; document.getElementById("img_id").style.display = "none";});
                            	obj.attachEvent("onmouseout",function(){ document.getElementById("icon_pop").style.display = "none";  document.getElementById("img_id").style.display = ""; });
                              }
                              if(isCurrIE7){
                            	document.getElementById("span0").style.left = "217px"; 
                            	document.getElementById("span0").style.top = "131px"; 
                            	var obj=document.getElementById("icon_event");
                            	obj.attachEvent("onmouseover",function(){ document.getElementById("img_id").style.display = "none";});
                            	obj.attachEvent("onmouseout",function(){  document.getElementById("img_id").style.display = ""; });
                              }
          } catch (e) {}
       </script>   

       <!--软键盘 结束-->	 
       </td>
	   <td width="30px"></td>
	   <td class="form_area_table_r" style="padding-left:0px;"><a tabindex="-1" href="#" onclick="refreshLoginPwd();">忘记密码？</a></td>
	   </tr>

       <div align="center" id="softkeyboard" name="softkeyboard" style="position: absolute; left: 14px; top: 141px; width: 400px; z-index: 65535; display: block;"><table id="CalcTable" width="" border="0" align="center" cellpadding="0" cellspacing="0" bgcolor="" style="border: 1px solid rgb(181, 173, 241);"><form id="Calc" name="Calc" action="" method="post" autocomplete="off"></form><tbody><tr><td class="table_title" title="尊敬的客户：为了保证网上交易安全,建议使用密码输入器输入密码!" align="right" valign="middle" bgcolor="" style="cursor: default; background-color: rgb(181, 173, 241);"><input type="hidden" value="R4_D=7y" name="password"><input type="hidden" value="ok" name="action2">&nbsp;<font style="font-weight:bold; font-size:15px; color:#075BC3">中国建设银行&nbsp;&nbsp;密码输入器</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input id="useKey" class="btn_letter" style="width:110px;height:25px;BORDER:1px solid blue; font-size:14px" type="button" value="使用键盘输入" bgtype="1" onclick="password1.readOnly=0;password1.focus();closekeyboard();password1.value='';setShowKeyBoard(false);" onkeyup="if(event.keyCode==13){password1.readOnly=0;password1.focus();closekeyboard();password1.value='';setShowKeyBoard(false);}"><span style="width:2px;"></span></td></tr><tr align="center"><td align="center" bgcolor="#FFFFFF"><table align="center" width="%" border="0" cellspacing="1" cellpadding="0">
		<tbody><tr align="left" valign="middle"> 
		<td> <input type="button" value="~" class="btn_letter"></td>
		<td> <input type="button" value="!" class="btn_letter"></td>
		<td> <input type="button" value="@" class="btn_letter"></td>
		<td> <input type="button" value="#" class="btn_letter"></td>
		<td> <input type="button" value="$" class="btn_letter"></td>
		<td><input type="button" value="%" class="btn_letter"></td>
		<td><input type="button" value="^" class="btn_letter"></td>
		<td> <input type="button" value="&amp;" class="btn_letter"></td>
		<td><input type="button" value="*" class="btn_letter"></td>
		<td><input type="button" value="(" class="btn_letter"></td>
		<td><input type="button" value=")" class="btn_letter"></td>
		<td><input type="button" value="_" class="btn_letter"></td>
		<td> <input type="button" value="+" class="btn_letter"></td>
		<td><input type="button" value="|" class="btn_letter"></td>
		<td colspan="1" rowspan="2"> <input name="button10" type="button" value=" 退格 " onmouseup="setpassvalue();" '="" style="width:100px;height:42px;BORDER-RIGHT:1px none;FONT-SIZE: 18px" class="btn_letter"> 
		</td>
		</tr>
		<tr align="left" valign="middle"> 
		<td><input width="38" height="38" type="button" value="`" class="btn_letter"></td>
		<td><input type="button" bgtype="2" name="button_number1" value="3" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number2" value="2" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number3" value="0" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number4" value="4" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number5" value="1" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number6" value="6" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number7" value="7" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number8" value="5" class="btn_letter"></td>
		<td> <input type="button" bgtype="2" name="button_number9" value="8" class="btn_letter"></td>
		<td> <input bgtype="2" name="button_number0" type="button" value="9" class="btn_letter"></td>
		<td> <input type="button" value="-" class="btn_letter"></td>
		<td> <input type="button" value="=" class="btn_letter"></td>
		<td> <input type="button" value="\" class="btn_letter"></td>
		<td> </td>
		</tr>
		<tr align="left" valign="middle"> 
		<td> <input type="button" value="q" class="btn_letter"></td>
		<td> <input type="button" value="w" class="btn_letter"></td>
		<td> <input type="button" value="e" class="btn_letter"></td>
		<td> <input type="button" value="r" class="btn_letter"></td>
		<td> <input type="button" value="t" class="btn_letter"></td>
		<td> <input type="button" value="y" class="btn_letter"></td>
		<td> <input type="button" value="u" class="btn_letter"></td>
		<td> <input type="button" value="i" class="btn_letter"></td>
		<td> <input type="button" value="o" class="btn_letter"></td>
		<td> <input name="button8" type="button" value="p" class="btn_letter"></td>
		<td> <input name="button9" type="button" value="{" class="btn_letter"></td>
		<td> <input type="button" value="}" class="btn_letter"></td>
		<td> <input type="button" value="[" class="btn_letter"></td>
		<td> <input type="button" value="]" class="btn_letter"></td>
		<td><input name="button9" type="button" onclick="capsLockText();setCapsLock();" ondblclick="capsLockText();setCapsLock();" value="切换大/小写" style="width:100px;height:21px;BORDER-RIGHT:1px none;font-size:15px" class="btn_letter"></td>
		</tr>
		<tr align="left" valign="middle"> 
		<td> <input type="button" value="a" class="btn_letter"></td>
		<td> <input type="button" value="s" class="btn_letter"></td>
		<td> <input type="button" value="d" class="btn_letter"></td>
		<td> <input type="button" value="f" class="btn_letter"></td>
		<td> <input type="button" value="g" class="btn_letter"></td>
		<td> <input type="button" value="h" class="btn_letter"></td>
		<td> <input type="button" value="j" class="btn_letter"></td>
		<td> <input name="button3" type="button" value="k" class="btn_letter"></td>
		<td> <input name="button4" type="button" value="l" class="btn_letter"></td>
		<td> <input name="button5" type="button" value=":" class="btn_letter"></td>
		<td> <input name="button7" type="button" value="&quot;" class="btn_letter"></td>
		<td> <input type="button" value=";" class="btn_letter"></td>
		<td> <input type="button" value="'" class="btn_letter"></td>
		<td rowspan="2" colspan="2"> <input name="button12" type="button" bgtype="1" onclick="OverInput();" value="   确定   " style="BORDER:3px solid blue;width:126px;height:42px;FONT-SIZE: 18px;" class="btn_letter"></td>
		</tr>
		<tr align="left" valign="middle"> 
		<td><input name="button2" type="button" value="z" class="btn_letter"></td>
		<td> <input type="button" value="x" class="btn_letter"></td>
		<td> <input type="button" value="c" class="btn_letter"></td>
		<td> <input type="button" value="v" class="btn_letter"></td>
		<td> <input type="button" value="b" class="btn_letter"></td>
		<td> <input type="button" value="n" class="btn_letter"></td>
		<td> <input type="button" value="m" class="btn_letter"></td>
		<td> <input type="button" value="<" class="btn_letter"></td>
		<td> <input type="button" value=">" class="btn_letter"></td>
		<td> <input type="button" value="?" class="btn_letter"></td>
		<td> <input type="button" value="," class="btn_letter"></td>
		 <td> <input type="button" value="." class="btn_letter"></td>
		 <td> <input type="button" value="/" class="btn_letter"></td>
		</tr>
		</tbody></table></td></tr></tbody></table></div>


从这段代码中，可以发现：

- 键盘由HTML代码构成，而不是使用点击坐标返回值的方法。
- 代码
`<input type="button" bgtype="2" name="button_number5" value="1" class="btn_letter">`中可以看见每个软键盘对应的按键给的value值。此value值随着页面的手动右键刷新不断更改成为下一组随机数。

11/14/2015 1:52:39 PM 

4、使用Chorme中Network工具

可探查到：

![data](http://img.hoop8.com/attachments/1511/6181022830861.png)

此LOGPASS与输入的并不一致。

11/19/2015 11:21:05 PM 
